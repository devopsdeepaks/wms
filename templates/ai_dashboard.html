<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Data Layer - WMS Analytics</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
      .ai-chat-container {
        height: 500px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        background: #f8f9fa;
      }

      .query-message {
        background: #007bff;
        color: white;
        padding: 10px 15px;
        border-radius: 18px;
        margin: 10px 0;
        max-width: 80%;
        margin-left: auto;
        display: block;
      }

      .response-message {
        background: white;
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
        max-width: 90%;
      }

      .insight-card {
        border-left: 4px solid #007bff;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      }

      .sample-query {
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .sample-query:hover {
        background: #e9ecef;
        border-left: 4px solid #007bff;
      }

      .chart-container {
        min-height: 400px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .ai-icon {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
      }

      .loading-spinner {
        display: none;
      }

      .stats-card {
        background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        color: white;
        border: none;
      }

      .table-responsive {
        max-height: 400px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="#">
          <i class="fas fa-robot me-2"></i>AI Data Layer - WMS Analytics
        </a>
        <span class="navbar-text">
          <i class="fas fa-database me-1"></i>Intelligent Data Querying
        </span>
      </div>
    </nav>

    <div class="container-fluid mt-4">
      <div class="row">
        <!-- AI Query Interface -->
        <div class="col-lg-6">
          <div class="card h-100">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">
                <i class="fas fa-comments me-2"></i>AI Query Interface
              </h5>
            </div>
            <div class="card-body">
              <!-- Query Input -->
              <div class="mb-3">
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="fas fa-search"></i>
                  </span>
                  <input
                    type="text"
                    id="queryInput"
                    class="form-control"
                    placeholder="Ask anything about your data... (e.g., 'Show top selling products')"
                    autocomplete="off"
                  />
                  <button class="btn btn-primary" id="submitQuery">
                    <i class="fas fa-paper-plane"></i>
                  </button>
                </div>
              </div>

              <!-- Chat Container -->
              <div id="chatContainer" class="ai-chat-container">
                <div class="text-center text-muted py-4">
                  <i class="fas fa-robot fa-3x mb-3"></i>
                  <p>Ask me anything about your WMS data!</p>
                  <p class="small">
                    Try questions like "Show top selling products" or "Which
                    items have low stock?"
                  </p>
                </div>
              </div>

              <!-- Loading Spinner -->
              <div id="loadingSpinner" class="loading-spinner text-center py-3">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Processing...</span>
                </div>
                <p class="mt-2">Processing your query...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Sample Queries & Insights -->
        <div class="col-lg-6">
          <div class="row">
            <!-- Database Stats -->
            <div class="col-12 mb-3">
              <div class="card stats-card">
                <div class="card-body">
                  <h6 class="text-white mb-3">
                    <i class="fas fa-chart-bar me-2"></i>Database Overview
                  </h6>
                  <div class="row" id="statsContainer">
                    <div class="col-3 text-center">
                      <div class="h4 mb-0" id="productsCount">-</div>
                      <small>Products</small>
                    </div>
                    <div class="col-3 text-center">
                      <div class="h4 mb-0" id="salesCount">-</div>
                      <small>Sales</small>
                    </div>
                    <div class="col-3 text-center">
                      <div class="h4 mb-0" id="mappingsCount">-</div>
                      <small>Mappings</small>
                    </div>
                    <div class="col-3 text-center">
                      <div class="h4 mb-0" id="movementsCount">-</div>
                      <small>Movements</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Sample Queries -->
            <div class="col-12 mb-3">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>Sample Queries
                  </h6>
                </div>
                <div class="card-body p-2" id="sampleQueries">
                  <!-- Sample queries will be loaded here -->
                </div>
              </div>
            </div>

            <!-- Automated Insights -->
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0">
                    <i class="fas fa-brain me-2"></i>AI Insights
                  </h6>
                </div>
                <div class="card-body" id="insightsContainer">
                  <!-- Insights will be loaded here -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Results Section -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="card" id="resultsCard" style="display: none">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-chart-line me-2"></i>Query Results
              </h5>
            </div>
            <div class="card-body">
              <!-- Chart Container -->
              <div
                id="chartContainer"
                class="chart-container mb-4"
                style="display: none"
              >
                <!-- Chart will be rendered here -->
              </div>

              <!-- Table Container -->
              <div id="tableContainer" style="display: none">
                <div class="table-responsive">
                  <table
                    class="table table-striped table-hover"
                    id="resultsTable"
                  >
                    <thead class="table-dark">
                      <!-- Table headers will be generated -->
                    </thead>
                    <tbody>
                      <!-- Table data will be generated -->
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Query Info -->
              <div id="queryInfo" class="mt-3">
                <small class="text-muted">
                  <strong>SQL Query:</strong> <code id="sqlQuery"></code>
                </small>
                <br />
                <small class="text-muted">
                  <strong>Results:</strong> <span id="rowCount"></span> rows |
                  <strong>Calculated Fields:</strong>
                  <span id="calcFields"></span>
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      class AIDataInterface {
        constructor() {
          this.initializeEventListeners();
          this.loadInitialData();
        }

        initializeEventListeners() {
          // Query submission
          document
            .getElementById("submitQuery")
            .addEventListener("click", () => {
              this.submitQuery();
            });

          document
            .getElementById("queryInput")
            .addEventListener("keypress", (e) => {
              if (e.key === "Enter") {
                this.submitQuery();
              }
            });
        }

        async loadInitialData() {
          try {
            // Load database stats
            await this.loadDatabaseStats();

            // Load sample queries
            await this.loadSampleQueries();

            // Load insights
            await this.loadInsights();
          } catch (error) {
            console.error("Error loading initial data:", error);
          }
        }

        async loadDatabaseStats() {
          try {
            const response = await fetch("/api/database-stats");
            const data = await response.json();

            if (data.success) {
              const stats = data.stats;
              document.getElementById("productsCount").textContent =
                stats.products_count || 0;
              document.getElementById("salesCount").textContent =
                stats.sales_records_count || 0;
              document.getElementById("mappingsCount").textContent =
                stats.sku_mappings_count || 0;
              document.getElementById("movementsCount").textContent =
                stats.inventory_movements_count || 0;
            }
          } catch (error) {
            console.error("Error loading stats:", error);
          }
        }

        async loadSampleQueries() {
          try {
            const response = await fetch("/api/sample-queries");
            const data = await response.json();

            const container = document.getElementById("sampleQueries");
            container.innerHTML = "";

            data.queries.forEach((query) => {
              const queryElement = document.createElement("div");
              queryElement.className = "p-2 mb-1 sample-query rounded";
              queryElement.innerHTML = `
                            <small class="text-primary">
                                <i class="fas fa-question-circle me-1"></i>${query}
                            </small>
                        `;
              queryElement.addEventListener("click", () => {
                document.getElementById("queryInput").value = query;
                this.submitQuery();
              });
              container.appendChild(queryElement);
            });
          } catch (error) {
            console.error("Error loading sample queries:", error);
          }
        }

        async loadInsights() {
          try {
            const response = await fetch("/api/insights");
            const data = await response.json();

            const container = document.getElementById("insightsContainer");
            container.innerHTML = "";

            if (data.insights && data.insights.length > 0) {
              data.insights.forEach((insight) => {
                const insightElement = document.createElement("div");
                insightElement.className = `alert alert-${this.getInsightClass(
                  insight.type
                )} insight-card mb-2`;
                insightElement.innerHTML = `
                                <strong>${insight.title}</strong><br>
                                <small>${insight.message}</small>
                            `;
                container.appendChild(insightElement);
              });
            } else {
              container.innerHTML =
                '<p class="text-muted small">No insights available yet. Try running some queries!</p>';
            }
          } catch (error) {
            console.error("Error loading insights:", error);
          }
        }

        getInsightClass(type) {
          const classMap = {
            success: "success",
            warning: "warning",
            info: "info",
            error: "danger",
          };
          return classMap[type] || "info";
        }

        async submitQuery() {
          const query = document.getElementById("queryInput").value.trim();
          if (!query) return;

          this.showLoading(true);
          this.addQueryToChat(query);

          try {
            const response = await fetch("/api/ai-query", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ query: query }),
            });

            const result = await response.json();
            this.displayQueryResult(result);

            // Clear input
            document.getElementById("queryInput").value = "";
          } catch (error) {
            this.displayError("Error processing query: " + error.message);
          } finally {
            this.showLoading(false);
          }
        }

        addQueryToChat(query) {
          const chatContainer = document.getElementById("chatContainer");
          const queryElement = document.createElement("div");
          queryElement.className = "query-message";
          queryElement.textContent = query;
          chatContainer.appendChild(queryElement);
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        displayQueryResult(result) {
          const chatContainer = document.getElementById("chatContainer");
          const responseElement = document.createElement("div");
          responseElement.className = "response-message";

          if (result.success) {
            responseElement.innerHTML = `
                        <div class="d-flex align-items-start">
                            <div class="ai-icon">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="flex-grow-1">
                                <strong>${result.chart.title}</strong>
                                <p class="small mb-2">Found ${
                                  result.row_count
                                } results</p>
                                ${
                                  result.calculated_fields.length > 0
                                    ? `<p class="small text-success mb-0">
                                        <i class="fas fa-plus-circle me-1"></i>
                                        Added calculated fields: ${result.calculated_fields.join(
                                          ", "
                                        )}
                                    </p>`
                                    : ""
                                }
                            </div>
                        </div>
                    `;

            // Show detailed results
            this.showDetailedResults(result);
          } else {
            responseElement.innerHTML = `
                        <div class="d-flex align-items-start">
                            <div class="ai-icon bg-danger">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="flex-grow-1">
                                <strong>Query Error</strong>
                                <p class="small mb-0">${
                                  result.error || result.message
                                }</p>
                            </div>
                        </div>
                    `;
          }

          chatContainer.appendChild(responseElement);
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        showDetailedResults(result) {
          const resultsCard = document.getElementById("resultsCard");
          const chartContainer = document.getElementById("chartContainer");
          const tableContainer = document.getElementById("tableContainer");

          // Update query info
          document.getElementById("sqlQuery").textContent = result.sql;
          document.getElementById("rowCount").textContent = result.row_count;
          document.getElementById("calcFields").textContent =
            result.calculated_fields.length > 0
              ? result.calculated_fields.join(", ")
              : "None";

          if (result.chart.type === "chart") {
            // Show chart
            chartContainer.style.display = "block";
            tableContainer.style.display = "none";
            Plotly.newPlot(
              "chartContainer",
              result.chart.chart.data,
              result.chart.chart.layout
            );
          } else {
            // Show table
            chartContainer.style.display = "none";
            tableContainer.style.display = "block";
            this.createTable(result.data);
          }

          resultsCard.style.display = "block";
          resultsCard.scrollIntoView({ behavior: "smooth" });
        }

        createTable(data) {
          if (!data || data.length === 0) return;

          const table = document.getElementById("resultsTable");
          const thead = table.querySelector("thead");
          const tbody = table.querySelector("tbody");

          // Clear existing content
          thead.innerHTML = "";
          tbody.innerHTML = "";

          // Create headers
          const headerRow = document.createElement("tr");
          Object.keys(data[0]).forEach((key) => {
            const th = document.createElement("th");
            th.textContent = key.replace(/_/g, " ").toUpperCase();
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);

          // Create data rows
          data.forEach((row) => {
            const tr = document.createElement("tr");
            Object.values(row).forEach((value) => {
              const td = document.createElement("td");
              td.textContent = value;
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });
        }

        showLoading(show) {
          const spinner = document.getElementById("loadingSpinner");
          spinner.style.display = show ? "block" : "none";
        }

        displayError(message) {
          const chatContainer = document.getElementById("chatContainer");
          const errorElement = document.createElement("div");
          errorElement.className = "response-message border-danger";
          errorElement.innerHTML = `
                    <div class="d-flex align-items-start">
                        <div class="ai-icon bg-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="flex-grow-1">
                            <strong>Error</strong>
                            <p class="small mb-0">${message}</p>
                        </div>
                    </div>
                `;
          chatContainer.appendChild(errorElement);
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }
      }

      // Initialize the AI interface when page loads
      document.addEventListener("DOMContentLoaded", () => {
        new AIDataInterface();
      });
    </script>
  </body>
</html>
