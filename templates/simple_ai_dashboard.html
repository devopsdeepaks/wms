<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simple AI WMS</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
      .chat-container {
        height: 400px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        background: #f8f9fa;
      }

      .query-message {
        background: #007bff;
        color: white;
        padding: 8px 12px;
        border-radius: 15px;
        margin: 8px 0;
        margin-left: auto;
        display: inline-block;
        max-width: 80%;
      }

      .response-message {
        background: white;
        border: 1px solid #ddd;
        padding: 12px;
        border-radius: 8px;
        margin: 8px 0;
        max-width: 90%;
      }

      .sample-query {
        cursor: pointer;
        padding: 8px;
        margin: 4px 0;
        border-radius: 4px;
        border: 1px solid #ddd;
        transition: background 0.3s;
      }

      .sample-query:hover {
        background: #e9ecef;
        border-color: #007bff;
      }

      .stats-card {
        background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        color: white;
        border: none;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="#">ü§ñ Simple AI WMS</a>
        <span class="navbar-text">Natural Language Data Queries</span>
      </div>
    </nav>

    <div class="container mt-4">
      <div class="row">
        <!-- Query Interface -->
        <div class="col-lg-8">
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">Ask AI About Your Data</h5>
            </div>
            <div class="card-body">
              <!-- Query Input -->
              <div class="input-group mb-3">
                <input
                  type="text"
                  id="queryInput"
                  class="form-control"
                  placeholder="Ask anything... (e.g., 'Show top selling products')"
                  autocomplete="off"
                />
                <button
                  class="btn btn-primary"
                  id="submitBtn"
                  onclick="submitQuery()"
                >
                  <i class="fas fa-search"></i> Ask AI
                </button>
              </div>

              <!-- Chat Container -->
              <div id="chatContainer" class="chat-container">
                <div class="text-center text-muted py-4">
                  <h5>ü§ñ AI Assistant Ready!</h5>
                  <p>Ask me anything about your WMS data...</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Results Container -->
          <div id="resultsCard" class="card mt-3" style="display: none">
            <div class="card-header">
              <h6 class="mb-0">Query Results</h6>
            </div>
            <div class="card-body">
              <div id="chartContainer" style="min-height: 400px"></div>
              <div id="tableContainer"></div>
              <small class="text-muted mt-2">
                <strong>SQL:</strong> <code id="sqlQuery"></code>
              </small>
            </div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
          <!-- Stats -->
          <div class="card stats-card mb-3">
            <div class="card-body">
              <h6 class="text-white mb-3">Database Overview</h6>
              <div class="row text-center">
                <div class="col-6">
                  <div class="h4 mb-0" id="productCount">-</div>
                  <small>Products</small>
                </div>
                <div class="col-6">
                  <div class="h4 mb-0" id="salesCount">-</div>
                  <small>Sales</small>
                </div>
              </div>
              <div class="row text-center mt-2">
                <div class="col-6">
                  <div class="h4 mb-0" id="platformCount">-</div>
                  <small>Platforms</small>
                </div>
                <div class="col-6">
                  <div class="h4 mb-0" id="lowStockCount">-</div>
                  <small>Low Stock</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Sample Queries -->
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">Try These Queries</h6>
            </div>
            <div class="card-body p-2" id="sampleQueries">
              <!-- Sample queries loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Load initial data
      document.addEventListener("DOMContentLoaded", function () {
        loadStats();
        loadSampleQueries();

        // Enter key support
        document
          .getElementById("queryInput")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              submitQuery();
            }
          });
      });

      async function loadStats() {
        try {
          const response = await fetch("/api/stats");
          const stats = await response.json();

          document.getElementById("productCount").textContent = stats.products;
          document.getElementById("salesCount").textContent = stats.sales;
          document.getElementById("platformCount").textContent =
            stats.platforms;
          document.getElementById("lowStockCount").textContent =
            stats.low_stock;
        } catch (error) {
          console.error("Error loading stats:", error);
        }
      }

      async function loadSampleQueries() {
        try {
          const response = await fetch("/api/samples");
          const data = await response.json();

          const container = document.getElementById("sampleQueries");
          container.innerHTML = "";

          data.queries.forEach((query) => {
            const div = document.createElement("div");
            div.className = "sample-query";
            div.textContent = query;
            div.onclick = () => {
              document.getElementById("queryInput").value = query;
              submitQuery();
            };
            container.appendChild(div);
          });
        } catch (error) {
          console.error("Error loading sample queries:", error);
        }
      }

      async function submitQuery() {
        const queryInput = document.getElementById("queryInput");
        const query = queryInput.value.trim();

        if (!query) return;

        // Add query to chat
        addQueryToChat(query);

        // Show loading
        const submitBtn = document.getElementById("submitBtn");
        submitBtn.innerHTML =
          '<span class="spinner-border spinner-border-sm"></span> Processing...';
        submitBtn.disabled = true;

        try {
          const response = await fetch("/api/query", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ query: query }),
          });

          const result = await response.json();
          displayResult(result);

          // Clear input
          queryInput.value = "";
        } catch (error) {
          displayError("Error: " + error.message);
        } finally {
          submitBtn.innerHTML = '<i class="fas fa-search"></i> Ask AI';
          submitBtn.disabled = false;
        }
      }

      function addQueryToChat(query) {
        const chatContainer = document.getElementById("chatContainer");
        const div = document.createElement("div");
        div.className = "query-message";
        div.textContent = query;
        chatContainer.appendChild(div);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      function displayResult(result) {
        const chatContainer = document.getElementById("chatContainer");
        const responseDiv = document.createElement("div");
        responseDiv.className = "response-message";

        if (result.success) {
          responseDiv.innerHTML = `
                    <strong>‚úÖ ${result.title}</strong><br>
                    <small>Found ${result.row_count} results</small>
                `;

          // Show detailed results
          showDetailedResults(result);
        } else {
          responseDiv.innerHTML = `
                    <strong>‚ùå Error</strong><br>
                    <small>${result.error}</small>
                `;
        }

        chatContainer.appendChild(responseDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      function showDetailedResults(result) {
        const resultsCard = document.getElementById("resultsCard");
        const chartContainer = document.getElementById("chartContainer");
        const tableContainer = document.getElementById("tableContainer");
        const sqlQuery = document.getElementById("sqlQuery");

        // Update SQL
        sqlQuery.textContent = result.sql;

        if (result.chart.type === "chart") {
          // Show chart
          chartContainer.style.display = "block";
          tableContainer.style.display = "none";
          Plotly.newPlot(
            "chartContainer",
            result.chart.chart.data,
            result.chart.chart.layout
          );
        } else {
          // Show table
          chartContainer.style.display = "none";
          tableContainer.style.display = "block";
          createTable(result.data);
        }

        resultsCard.style.display = "block";
        resultsCard.scrollIntoView({ behavior: "smooth" });
      }

      function createTable(data) {
        if (!data || data.length === 0) return;

        const tableContainer = document.getElementById("tableContainer");

        let html =
          '<div class="table-responsive"><table class="table table-striped"><thead class="table-dark"><tr>';

        // Headers
        Object.keys(data[0]).forEach((key) => {
          html += `<th>${key.replace(/_/g, " ").toUpperCase()}</th>`;
        });
        html += "</tr></thead><tbody>";

        // Data rows
        data.forEach((row) => {
          html += "<tr>";
          Object.values(row).forEach((value) => {
            html += `<td>${value}</td>`;
          });
          html += "</tr>";
        });

        html += "</tbody></table></div>";
        tableContainer.innerHTML = html;
      }

      function displayError(message) {
        const chatContainer = document.getElementById("chatContainer");
        const div = document.createElement("div");
        div.className = "response-message border-danger";
        div.innerHTML = `<strong>‚ùå Error</strong><br><small>${message}</small>`;
        chatContainer.appendChild(div);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
    </script>
  </body>
</html>
