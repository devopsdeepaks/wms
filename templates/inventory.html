{% extends "base.html" %} {% block content %}
<div class="row">
  <div class="col-12">
    <h1 class="mb-4">
      <i class="fas fa-boxes me-2"></i>
      Inventory Management
    </h1>
    <p class="text-muted mb-4">
      View and manage current inventory levels, stock status, and product
      information.
    </p>
  </div>
</div>

<!-- Inventory Summary -->
<div class="row mb-4">
  <div class="col-md-3 mb-3">
    <div class="card stat-card">
      <div class="card-body text-center">
        <i class="fas fa-cube fa-2x text-primary mb-3"></i>
        <h3 class="card-title" id="total-items">0</h3>
        <p class="card-text text-muted">Total Items</p>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card stat-card">
      <div class="card-body text-center">
        <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
        <h3 class="card-title" id="low-stock-items">0</h3>
        <p class="card-text text-muted">Low Stock</p>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card stat-card">
      <div class="card-body text-center">
        <i class="fas fa-times-circle fa-2x text-danger mb-3"></i>
        <h3 class="card-title" id="out-of-stock">0</h3>
        <p class="card-text text-muted">Out of Stock</p>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card stat-card">
      <div class="card-body text-center">
        <i class="fas fa-arrow-down fa-2x text-danger mb-3"></i>
        <h3 class="card-title" id="negative-stock">0</h3>
        <p class="card-text text-muted">Negative Stock</p>
      </div>
    </div>
  </div>
</div>

<!-- Actions Bar -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text">
                <i class="fas fa-search"></i>
              </span>
              <input
                type="text"
                class="form-control"
                id="search-input"
                placeholder="Search by MSKU, SKU, or product name..."
              />
            </div>
          </div>
          <div class="col-md-3">
            <select class="form-select" id="stock-filter">
              <option value="all">All Items</option>
              <option value="low">Low Stock (< 10)</option>
              <option value="out">Out of Stock (0)</option>
              <option value="negative">Negative Stock (< 0)</option>
              <option value="good">Good Stock (â‰¥ 10)</option>
            </select>
          </div>
          <div class="col-md-3">
            <div class="btn-group w-100">
              <button
                type="button"
                class="btn btn-outline-primary"
                onclick="refreshInventory()"
              >
                <i class="fas fa-sync-alt me-2"></i>
                Refresh
              </button>
              <button
                type="button"
                class="btn btn-success"
                onclick="exportInventory()"
              >
                <i class="fas fa-download me-2"></i>
                Export
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Inventory Table -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fas fa-table me-2"></i>
          Current Inventory
        </h5>
      </div>
      <div class="card-body">
        <!-- Loading State -->
        <div class="loading text-center p-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Loading inventory data...</p>
        </div>

        <!-- Table -->
        <div
          class="table-responsive"
          id="inventory-table-container"
          style="display: none"
        >
          <table class="table table-hover" id="inventory-table">
            <thead>
              <tr>
                <th>MSKU</th>
                <th>Product Name</th>
                <th>Current Stock</th>
                <th>Status</th>
                <th>Last Updated</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="inventory-tbody"></tbody>
          </table>
        </div>

        <!-- Empty State -->
        <div
          id="empty-state"
          class="text-center text-muted p-4"
          style="display: none"
        >
          <i class="fas fa-box-open fa-3x mb-3"></i>
          <p>No inventory data available</p>
        </div>

        <!-- Pagination -->
        <nav
          aria-label="Inventory pagination"
          id="pagination-container"
          style="display: none"
        >
          <ul class="pagination justify-content-center">
            <li class="page-item">
              <a class="page-link" href="#" onclick="changePage(-1)"
                >Previous</a
              >
            </li>
            <li class="page-item active">
              <span class="page-link" id="current-page">1</span>
            </li>
            <li class="page-item">
              <a class="page-link" href="#" onclick="changePage(1)">Next</a>
            </li>
          </ul>
          <small
            class="text-muted d-block text-center mt-2"
            id="pagination-info"
          >
            Showing 1-50 of 100 items
          </small>
        </nav>
      </div>
    </div>
  </div>
</div>

<!-- Combo Analysis Modal -->
<div class="modal fade" id="comboModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-layer-group me-2"></i>
          Combo Products Analysis
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body" id="combo-modal-body">
        <!-- Combo content will be loaded here -->
      </div>
    </div>
  </div>
</div>

<style>
  .stock-status {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
    font-weight: 500;
  }

  .stock-good {
    background-color: #d1fae5;
    color: #065f46;
  }
  .stock-low {
    background-color: #fef3c7;
    color: #92400e;
  }
  .stock-out {
    background-color: #fee2e2;
    color: #991b1b;
  }
  .stock-negative {
    background-color: #fecaca;
    color: #7f1d1d;
  }

  .table th {
    position: sticky;
    top: 0;
    background-color: #f8fafc;
    z-index: 1;
  }

  .inventory-actions {
    white-space: nowrap;
  }
</style>
{% endblock %} {% block scripts %}
<script>
  let inventoryData = [];
  let filteredData = [];
  let currentPage = 1;
  const itemsPerPage = 50;

  document.addEventListener("DOMContentLoaded", function () {
    loadInventoryData();
    setupEventListeners();
  });

  function setupEventListeners() {
    // Search functionality
    document
      .getElementById("search-input")
      .addEventListener("input", function () {
        filterInventory();
      });

    // Stock filter
    document
      .getElementById("stock-filter")
      .addEventListener("change", function () {
        filterInventory();
      });
  }

  function loadInventoryData() {
    showLoading(true);

    fetch("/api/inventory")
      .then((response) => response.json())
      .then((data) => {
        showLoading(false);

        if (data.status === "success") {
          inventoryData = data.data;
          updateSummaryStats();
          filterInventory();
          document.getElementById("inventory-table-container").style.display =
            "block";
          document.getElementById("pagination-container").style.display =
            "block";
        } else {
          document.getElementById("empty-state").style.display = "block";
          showAlert(data.message, "warning");
        }
      })
      .catch((error) => {
        showLoading(false);
        console.error("Error loading inventory:", error);
        document.getElementById("empty-state").style.display = "block";
        showAlert("Failed to load inventory data", "danger");
      });
  }

  function updateSummaryStats() {
    const stats = calculateStats(inventoryData);

    document.getElementById("total-items").textContent = formatNumber(
      stats.total
    );
    document.getElementById("low-stock-items").textContent = formatNumber(
      stats.lowStock
    );
    document.getElementById("out-of-stock").textContent = formatNumber(
      stats.outOfStock
    );
    document.getElementById("negative-stock").textContent = formatNumber(
      stats.negativeStock
    );
  }

  function calculateStats(data) {
    let total = data.length;
    let lowStock = 0;
    let outOfStock = 0;
    let negativeStock = 0;

    data.forEach((item) => {
      const qty = getQuantity(item);
      if (qty < 0) negativeStock++;
      else if (qty === 0) outOfStock++;
      else if (qty < 10) lowStock++;
    });

    return { total, lowStock, outOfStock, negativeStock };
  }

  function getQuantity(item) {
    // Find quantity column (case insensitive)
    for (let key in item) {
      if (
        key.toLowerCase().includes("quantity") ||
        key.toLowerCase().includes("qty") ||
        key.toLowerCase().includes("stock")
      ) {
        return parseInt(item[key]) || 0;
      }
    }
    return 0;
  }

  function getMSKU(item) {
    for (let key in item) {
      if (key.toLowerCase().includes("msku")) {
        return item[key] || "N/A";
      }
    }
    return "N/A";
  }

  function getProductName(item) {
    for (let key in item) {
      if (
        key.toLowerCase().includes("name") ||
        key.toLowerCase().includes("product") ||
        key.toLowerCase().includes("title")
      ) {
        return item[key] || "N/A";
      }
    }
    return "N/A";
  }

  function filterInventory() {
    const searchTerm = document
      .getElementById("search-input")
      .value.toLowerCase();
    const stockFilter = document.getElementById("stock-filter").value;

    filteredData = inventoryData.filter((item) => {
      // Search filter
      const msku = getMSKU(item).toLowerCase();
      const productName = getProductName(item).toLowerCase();
      const searchMatch =
        !searchTerm ||
        msku.includes(searchTerm) ||
        productName.includes(searchTerm);

      // Stock filter
      const qty = getQuantity(item);
      let stockMatch = true;

      switch (stockFilter) {
        case "low":
          stockMatch = qty > 0 && qty < 10;
          break;
        case "out":
          stockMatch = qty === 0;
          break;
        case "negative":
          stockMatch = qty < 0;
          break;
        case "good":
          stockMatch = qty >= 10;
          break;
      }

      return searchMatch && stockMatch;
    });

    currentPage = 1;
    displayInventory();
  }

  function displayInventory() {
    const tbody = document.getElementById("inventory-tbody");
    tbody.innerHTML = "";

    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageData = filteredData.slice(startIndex, endIndex);

    pageData.forEach((item) => {
      const qty = getQuantity(item);
      const msku = getMSKU(item);
      const productName = getProductName(item);

      const row = document.createElement("tr");
      row.innerHTML = `
            <td><strong>${msku}</strong></td>
            <td>${productName}</td>
            <td>${formatNumber(qty)}</td>
            <td>${getStockStatusBadge(qty)}</td>
            <td>${new Date().toLocaleDateString()}</td>
            <td class="inventory-actions">
                <button type="button" class="btn btn-sm btn-outline-primary" 
                        onclick="viewDetails('${msku}')">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        `;
      tbody.appendChild(row);
    });

    updatePagination();
  }

  function getStockStatusBadge(qty) {
    if (qty < 0) {
      return '<span class="stock-status stock-negative">Negative Stock</span>';
    } else if (qty === 0) {
      return '<span class="stock-status stock-out">Out of Stock</span>';
    } else if (qty < 10) {
      return '<span class="stock-status stock-low">Low Stock</span>';
    } else {
      return '<span class="stock-status stock-good">In Stock</span>';
    }
  }

  function updatePagination() {
    const totalPages = Math.ceil(filteredData.length / itemsPerPage);
    const currentPageElement = document.getElementById("current-page");
    const paginationInfo = document.getElementById("pagination-info");

    currentPageElement.textContent = currentPage;

    const startItem = (currentPage - 1) * itemsPerPage + 1;
    const endItem = Math.min(currentPage * itemsPerPage, filteredData.length);

    paginationInfo.textContent = `Showing ${startItem}-${endItem} of ${filteredData.length} items`;

    // Update pagination buttons
    const prevButton = document.querySelector(
      ".pagination .page-item:first-child"
    );
    const nextButton = document.querySelector(
      ".pagination .page-item:last-child"
    );

    prevButton.classList.toggle("disabled", currentPage === 1);
    nextButton.classList.toggle("disabled", currentPage === totalPages);
  }

  function changePage(direction) {
    const totalPages = Math.ceil(filteredData.length / itemsPerPage);
    const newPage = currentPage + direction;

    if (newPage >= 1 && newPage <= totalPages) {
      currentPage = newPage;
      displayInventory();
    }
  }

  function refreshInventory() {
    loadInventoryData();
    showAlert("Inventory data refreshed", "success");
  }

  function exportInventory() {
    window.open("/api/export-inventory", "_blank");
    showAlert("Inventory export started", "info");
  }

  function viewDetails(msku) {
    showAlert(`Viewing details for ${msku}`, "info");
  }

  function viewComboAnalysis() {
    fetch("/api/combo-analysis")
      .then((response) => response.json())
      .then((data) => {
        if (data.status === "success") {
          displayComboModal(data);
        } else {
          showAlert("Failed to load combo analysis", "danger");
        }
      })
      .catch((error) => {
        console.error("Error loading combo analysis:", error);
        showAlert("Failed to load combo analysis", "danger");
      });
  }

  function displayComboModal(data) {
    const modalBody = document.getElementById("combo-modal-body");

    let html = `
        <div class="mb-3">
            <h6>Summary</h6>
            <p>Total combo products: <strong>${data.total_combos}</strong></p>
        </div>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Combo SKU</th>
                        <th>Components</th>
                        <th>Component Count</th>
                    </tr>
                </thead>
                <tbody>
    `;

    data.combo_data.forEach((combo) => {
      html += `
            <tr>
                <td><strong>${combo.combo_sku}</strong></td>
                <td>
                    <small>${combo.components.join(", ")}</small>
                </td>
                <td>
                    <span class="badge bg-primary">${
                      combo.component_count
                    }</span>
                </td>
            </tr>
        `;
    });

    html += "</tbody></table></div>";

    modalBody.innerHTML = html;

    const comboModal = new bootstrap.Modal(
      document.getElementById("comboModal")
    );
    comboModal.show();
  }
</script>
{% endblock %}
